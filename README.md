# Grafana Dashboard JSON to Jsonnet Transformer

A skill that transforms Grafana dashboard JSON files into well-structured Jsonnet programs with extracted templates and variables.

## Features

- **Parse JSON files** - Read and validate Grafana dashboard JSON files
- **Analyze patterns** - Detect repeated values, common configurations, and panel structures
- **Generate Jsonnet** - Create clean, maintainable Jsonnet code
- **Extract variables** - Pull out repeated values into local variables
- **Create templates** - Generate reusable panel template functions
- **Support multiple panel types** - graph, timeseries, stat, gauge, table, piechart, barchart, heatmap, logs, text

## Installation

```bash
# Clone the repository
git clone <repository-url>
cd jsonnet-transformer

# Install dependencies
pip install -e .
```

## Quick Start

### Command Line Usage

```bash
# Transform a JSON file to Jsonnet
python -m src.main --input examples/input/sample_dashboard.json --output output.jsonnet

# Transform with options
python -m src.main --input dashboard.json --output dashboard.jsonnet \
    --no-comments --extract-repeated --create-templates
```

### Python API

```python
from src import transform, transform_string, TransformOptions

# Transform a file
result = transform('dashboard.json')
print(result.jsonnet_code)

# Transform a string
json_string = '{"dashboard": {"title": "My Dashboard", "panels": []}}'
result = transform_string(json_string)
print(result.jsonnet_code)

# Transform with options
options = TransformOptions(
    extract_repeated=True,
    create_templates=True,
    add_comments=True,
    output_file='output.jsonnet'
)
result = transform('dashboard.json', options)
```

## Transformation Examples

### Input (JSON)
```json
{
  "dashboard": {
    "title": "My Dashboard",
    "panels": [
      {
        "id": 1,
        "type": "graph",
        "title": "CPU Usage",
        "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
        "targets": [{"expr": "cpu_usage", "refId": "A"}]
      }
    ]
  }
}
```

### Output (Jsonnet)
```jsonnet
// Generated by Grafana Dashboard JSON to Jsonnet Transformer
// Source: My Dashboard

{
    title: 'My Dashboard',
    panels: [
        {
            // CPU Usage
            id: 1,
            type: 'graph',
            title: 'CPU Usage',
            gridPos: { x: 0, y: 0, w: 12, h: 8 },
            targets: [
                { expr: 'cpu_usage', refId: 'A' },
            ],
        },
    ],
}
```

## Panel Templates

The transformer creates template functions for common panel types:

```jsonnet
local statPanel(title, gridPos, targets, datasource) = {
    type: 'stat',
    title: title,
    gridPos: gridPos,
    targets: targets,
    // ... default configuration
};

local timeseriesPanel(title, gridPos, targets, datasource) = {
    type: 'timeseries',
    title: title,
    gridPos: gridPos,
    targets: targets,
    // ... default configuration
};
```

## Configuration Options

### TransformOptions

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `validate` | `bool` | `True` | Validate JSON structure |
| `min_pattern_occurrences` | `int` | `2` | Minimum occurrences for pattern detection |
| `extract_repeated` | `bool` | `True` | Extract repeated values |
| `create_templates` | `bool` | `True` | Create panel templates |
| `add_comments` | `bool` | `True` | Add comments to output |
| `include_imports` | `bool` | `False` | Include import statements |
| `indent_size` | `int` | `4` | Spaces per indent level |
| `max_line_length` | `int` | `120` | Maximum line length |
| `output_file` | `str` | `None` | Output file path |
| `overwrite` | `bool` | `False` | Overwrite output file |

## Project Structure

```
jsonnet-transformer/
├── skill.json                 # Skill configuration
├── src/
│   ├── __init__.py            # Package init
│   ├── main.py                # Main transformation pipeline
│   ├── parser.py              # JSON parsing
│   ├── analyzer.py            # Dashboard analysis
│   ├── patterns.py            # Pattern detection
│   ├── generator.py           # Jsonnet code generation
│   └── templates/
│       ├── __init__.py
│       ├── panels.py          # Panel template functions
│       └── mixins.py          # Configuration mixins
├── tests/
│   ├── __init__.py
│   ├── test_parser.py
│   ├── test_analyzer.py
│   ├── test_generator.py
│   └── test_integration.py
├── examples/
│   ├── input/
│   │   └── sample_dashboard.json
│   └── output/
│       └── sample_dashboard.jsonnet
└── docs/
    ├── README.md
    └── API.md
```

## Running Tests

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src

# Run specific test file
pytest tests/test_parser.py
```

## Supported Panel Types

- `graph` - Line/area chart
- `timeseries` - Modern time series chart
- `stat` - Single value display
- `gauge` - Gauge visualization
- `table` - Tabular data
- `piechart` - Pie/donut chart
- `barchart` - Bar chart
- `heatmap` - Heatmap visualization
- `logs` - Log viewer
- `text` - Text panel

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for your changes
4. Ensure all tests pass
5. Submit a pull request

## License

MIT License